<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‚Äì‡∏Ñ‡∏∑‡∏ô‡∏£‡πà‡∏° Ultra+ Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
    body { font-family: 'Sarabun', sans-serif; }
    .glass-morphism {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
    }
    .dark .glass-morphism {
        background: rgba(17, 24, 39, 0.85);
    }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #4B5563; }
</style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 dark:from-gray-900 dark:via-gray-800 dark:to-black min-h-screen transition-all duration-500" id="body">

<div class="container mx-auto px-4 py-8 max-w-5xl">
  
  <div class="flex justify-between items-center mb-8 animate-fade-in-down">
    <div>
        <h1 class="text-3xl md:text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400 drop-shadow-sm">
            ‚òÇÔ∏è Umbrella Station
        </h1>
        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏£‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ Ultra+ Pro</p>
    </div>
    <button onclick="toggleDarkMode()" class="p-3 rounded-full bg-white dark:bg-gray-700 shadow-lg hover:scale-110 transition-transform active:scale-95">
        <span id="themeIcon" class="text-xl">üåì</span>
    </button>
  </div>

  <div class="grid grid-cols-3 gap-4 mb-8">
      <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-l-4 border-blue-500 flex flex-col items-center">
          <span class="text-2xl font-bold text-gray-800 dark:text-white" id="statTotal">0</span>
          <span class="text-xs text-gray-500 uppercase tracking-wider">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-l-4 border-green-500 flex flex-col items-center">
          <span class="text-2xl font-bold text-green-600 dark:text-green-400" id="statAvailable">0</span>
          <span class="text-xs text-gray-500 uppercase tracking-wider">‡∏ß‡πà‡∏≤‡∏á</span>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-l-4 border-pink-500 flex flex-col items-center">
          <span class="text-2xl font-bold text-pink-600 dark:text-pink-400" id="statBorrowed">0</span>
          <span class="text-xs text-gray-500 uppercase tracking-wider">‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°</span>
      </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
    
    <div class="lg:col-span-7 space-y-6">
        <div class="glass-morphism rounded-3xl p-6 shadow-xl border border-white/20">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex items-center gap-2">
                üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏¢‡∏∑‡∏°
            </h2>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <input id="name" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white transition-all" />
                    <input id="room" type="text" placeholder="‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô 5/502)" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 focus:ring-2 focus:ring-purple-500 outline-none dark:text-white transition-all" />
                </div>
                <button onclick="borrow()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-3.5 rounded-xl font-bold shadow-lg hover:shadow-purple-500/30 transition-all transform hover:-translate-y-1 active:scale-95 flex justify-center items-center gap-2">
                    <span>‡∏¢‡∏∑‡∏°‡∏£‡πà‡∏°‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
        </div>

        <div class="space-y-4">
            <div class="relative">
                <input id="search" type="text" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™‡∏£‡πà‡∏°..." class="w-full p-3 pl-10 rounded-xl bg-white dark:bg-gray-800 border-none shadow-sm focus:ring-2 focus:ring-pink-400 outline-none dark:text-white" oninput="render()" />
                <span class="absolute left-3 top-3.5 text-gray-400"></span>
            </div>
            
            <div class="flex justify-between items-center px-2">
                <h3 class="font-bold text-gray-700 dark:text-gray-300">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</h3>
                <button onclick="downloadCSV()" class="text-xs font-bold text-purple-600 dark:text-purple-400 hover:underline">üìÑ Export CSV</button>
            </div>

            <div id="tableData" class="space-y-3 h-[400px] overflow-y-auto pr-2 pb-10">
                </div>
        </div>
    </div>

    <div class="lg:col-span-5">
        <div class="glass-morphism rounded-3xl p-6 shadow-xl border border-white/20 sticky top-6">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
                ‚òÇÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡πà‡∏° (Umbrella Slots)
            </h2>
            
            <div id="umbrellaGrid" class="grid grid-cols-3 gap-4">
                </div>

            <div class="mt-6 text-xs text-gray-500 dark:text-gray-400 text-center">
                <p>‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô</p>
            </div>
        </div>
    </div>

  </div>
</div>

<script>
// --- Configuration ---
const UMBRELLA_COUNT = 6;
let list = JSON.parse(localStorage.getItem("umbrellaList") || "[]");
let darkMode = localStorage.getItem("theme") === 'dark';

// --- Init ---
document.addEventListener('DOMContentLoaded', () => {
    if(darkMode) document.getElementById('body').classList.add('dark');
    render();
});

// --- Core Functions ---

function toggleDarkMode(){
  darkMode = !darkMode;
  document.getElementById('body').classList.toggle('dark', darkMode);
  localStorage.setItem("theme", darkMode ? 'dark' : 'light');
}

function save() {
  localStorage.setItem("umbrellaList", JSON.stringify(list));
  render();
}

function borrow() {
  const name = document.getElementById("name").value.trim();
  const room = document.getElementById("room").value.trim();
  
  if(!name || !room) {
      return Swal.fire({icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'});
  }

  // Find first available code
  let availableCode = null;
  for(let i=1; i<=UMBRELLA_COUNT; i++){
      let code = 'U' + i.toString().padStart(2,'0');
      if(!list.find(x => x.code === code)) {
          availableCode = code;
          break;
      }
  }

  if(!availableCode) {
      return Swal.fire({icon: 'error', title: '‡∏£‡πà‡∏°‡∏´‡∏°‡∏î!', text: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà'});
  }

  const timestamp = new Date().toISOString();
  list.push({ name, room, code: availableCode, time: timestamp });
  
  // Reset Inputs
  document.getElementById("name").value = "";
  document.getElementById("room").value = "";

  save();
  
  // Effects
  confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#a855f7', '#ec4899'] });
  Swal.fire({
      icon: 'success',
      title: '‡∏¢‡∏∑‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',
      html: `‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡πà‡∏°‡πÄ‡∏ö‡∏≠‡∏£‡πå <b>${availableCode}</b><br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 24 ‡∏ä‡∏°.`,
      timer: 2500,
      showConfirmButton: false
  });
  playSound('borrow');
}

function confirmReturn(code) {
    const item = list.find(x => x.code === code);
    if(!item) return;

    Swal.fire({
        title: `‡∏Ñ‡∏∑‡∏ô‡∏£‡πà‡∏° ${code}?`,
        html: `‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°: <b>${item.name}</b> (${item.room})<br>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏£‡πà‡∏°‡∏ô‡∏µ‡πâ`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10B981',
        cancelButtonColor: '#d33',
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏•‡∏¢!',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then((result) => {
        if (result.isConfirmed) {
            processReturn(code);
        }
    });
}

function processReturn(code) {
    list = list.filter(x => x.code !== code);
    save();
    Swal.fire({ icon: 'success', title: '‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', text: '‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', timer: 1500, showConfirmButton: false });
    playSound('return');
}

function render(){
  // 1. Update Stats
  const total = UMBRELLA_COUNT;
  const borrowed = list.length;
  const available = total - borrowed;
  
  document.getElementById('statTotal').innerText = total;
  document.getElementById('statAvailable').innerText = available;
  document.getElementById('statBorrowed').innerText = borrowed;

  // 2. Render Visual Slots (Right Column)
  const grid = document.getElementById("umbrellaGrid");
  grid.innerHTML = "";
  
  for(let i=1; i<=UMBRELLA_COUNT; i++){
      const code = 'U' + i.toString().padStart(2,'0');
      const item = list.find(x => x.code === code);
      const isBorrowed = !!item;
      
      const btn = document.createElement('div');
      // Styling based on status
      let colorClass = isBorrowed 
          ? "bg-red-100 dark:bg-red-900/30 border-red-400 text-red-600 dark:text-red-300 cursor-pointer hover:bg-red-200" 
          : "bg-green-100 dark:bg-green-900/30 border-green-400 text-green-600 dark:text-green-300";
      
      btn.className = `relative p-4 rounded-2xl border-2 flex flex-col items-center justify-center transition-all duration-300 ${colorClass}`;
      
      if(isBorrowed) {
          btn.onclick = () => confirmReturn(code);
          btn.innerHTML = `
            <div class="text-3xl mb-1">‚òÇÔ∏è</div>
            <div class="font-bold text-lg">${code}</div>
            <div class="text-[10px] truncate w-full text-center opacity-80">${item.name}</div>
          `;
      } else {
          btn.innerHTML = `
            <div class="text-3xl mb-1 opacity-30">‚òÇÔ∏è</div>
            <div class="font-bold text-lg">${code}</div>
            <div class="text-[10px] opacity-50">‡∏ß‡πà‡∏≤‡∏á</div>
          `;
      }
      grid.appendChild(btn);
  }

  // 3. Render List Data (Left Column)
  const tbody = document.getElementById("tableData");
  const search = document.getElementById("search").value.toLowerCase();
  tbody.innerHTML="";
  
  if(list.length===0){
    tbody.innerHTML=`
        <div class="text-center py-10 opacity-50">
            <div class="text-4xl mb-2">üçÉ</div>
            <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏¢‡∏∑‡∏°‡∏£‡πà‡∏°‡πÄ‡∏•‡∏¢</p>
        </div>`;
    return;
  }

  const now = new Date();
  const filteredList = list.filter(item=>
    item.name.toLowerCase().includes(search) || 
    item.code.toLowerCase().includes(search) ||
    item.room.toLowerCase().includes(search)
  );

  if(filteredList.length === 0) {
      tbody.innerHTML=`<p class='text-center text-gray-400 py-4'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>`;
      return;
  }

  filteredList.forEach(item=>{
    const borrowTime = new Date(item.time);
    const diffHours = (now - borrowTime)/1000/60/60;
    const remaining = 24 - diffHours;
    
    let statusColor = remaining > 0 ? 'border-purple-200 dark:border-purple-800' : 'border-red-400 bg-red-50 dark:bg-red-900/20';
    let timeText = remaining > 0 
        ? `<span class="text-green-600 font-semibold text-xs">‡∏Ñ‡∏∑‡∏ô‡πÉ‡∏ô ${remaining.toFixed(1)} ‡∏ä‡∏°.</span>` 
        : `<span class="text-red-600 font-bold text-xs animate-pulse">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î!</span>`;

    const card = document.createElement('div');
    card.className=`bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border-l-4 transition-all hover:shadow-md flex justify-between items-center ${statusColor}`;
    
    card.innerHTML=`
        <div>
            <div class="flex items-center gap-2">
                <span class="font-bold text-lg text-gray-800 dark:text-white">${item.code}</span>
                <span class="text-gray-400 text-xs">|</span>
                <span class="font-semibold text-gray-700 dark:text-gray-200">${item.name}</span>
            </div>
            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">‡∏´‡πâ‡∏≠‡∏á: ${item.room} ‚Ä¢ ${timeText}</div>
            <div class="text-[10px] text-gray-400 mt-0.5">${borrowTime.toLocaleString('th-TH')}</div>
        </div>
        <button onclick="confirmReturn('${item.code}')" class="bg-gray-100 hover:bg-green-500 hover:text-white text-gray-500 p-2 rounded-xl transition-all group" title="‡∏Ñ‡∏∑‡∏ô‡∏£‡πà‡∏°">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        </button>
    `;
    tbody.appendChild(card);
  });
}

function downloadCSV(){
  if(list.length === 0) return Swal.fire('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'info');
  
  let csv = '\uFEFF' + '‡∏ä‡∏∑‡πà‡∏≠,‡∏´‡πâ‡∏≠‡∏á,‡∏£‡∏´‡∏±‡∏™‡∏£‡πà‡∏°,‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏∑‡∏°\n'; // Add BOM for Thai Excel support
  list.forEach(x=>{csv+=`"${x.name}","${x.room}","${x.code}","${x.time}"\n`;});
  
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); 
  a.href=url; 
  a.download=`umbrella_report_${new Date().toISOString().slice(0,10)}.csv`; 
  a.click(); 
  URL.revokeObjectURL(url);
}

function playSound(type){
  // Low volume sound effects
  let src = type==='borrow' ? 'https://www.soundjay.com/button/sounds/button-3.mp3' : 'https://www.soundjay.com/button/sounds/button-4.mp3';
  let audio = new Audio(src);
  audio.volume = 0.3;
  audio.play().catch(e=>console.log("Audio play failed (user interaction needed)"));
}

</script>
</body>
</html>